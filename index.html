<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Speech Interface</title>
</head>

<body>
    <div>Talk to the Ollama REST API. Speak the word "prompt" as the wake word.</div>
    <select id="voicesDropdown" style="min-height: 40px; min-width: 500px;">
        <option value="">Select a voice</option>
    </select>
    <pre id="resultText" style="display: none"></pre>
    <div id="txtError"></div>
    <div id="ollamaPrompt"></div>
    <div id="ollamaResponse"></div>
    <script>

        var speechSynthesisVoices = [];

        function debugLog(msg) {
            console.log(msg);
        }

        function showError(msg) {
            debugLog(msg);
            txtError.innerText = msg;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function setupSpeechRecognition() {

            window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!window.SpeechRecognition) {
                showError('Speech Recognition is not supported by your browser!');
                return;
            }

            const recognition = new SpeechRecognition();
            if (!recognition) {
                showError('Could not instantiate SpeechRecognition!');
                return;
            }
            debugLog('Instantiated SpeechRecognition');
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            debugLog('SpeechRecognition: Set default language');

            recognition.addEventListener('result', e => {

                const results = Array.from(e.results);
                if (!results) {
                    return;
                }
                let jsonData = {};
                jsonData.results = [];
                for (let resultIndex = 0; resultIndex < results.length; ++resultIndex) {
                    //console.log(results[resultIndex]);
                    // SpeechRecognitionResult
                    let speechRecognitionResult = {};
                    speechRecognitionResult.isFinal = results[resultIndex].isFinal;
                    speechRecognitionResult.alternatives = [];
                    for (let setIndex = 0; setIndex < results[resultIndex].length; ++setIndex) {
                        //console.log(results[resultIndex][setIndex]);
                        // SpeechRecognitionAlternative
                        let speechRecognitionAlternative = {};
                        speechRecognitionAlternative.confidence = results[resultIndex][setIndex].confidence;
                        speechRecognitionAlternative.transcript = results[resultIndex][setIndex].transcript;
                        speechRecognitionResult.alternatives.push(speechRecognitionAlternative);
                    }
                    speechRecognitionResult.length = speechRecognitionResult.alternatives.length;
                    jsonData.results.push(speechRecognitionResult);
                }
                //debugLog(JSON.stringify(jsonData, null, 2));

                const transcript = Array.from(e.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');

                const WAKE_WORD = 'prompt';
                let index = transcript.toLocaleLowerCase().indexOf(WAKE_WORD);
                if (index >= 0) {
                    ollamaPrompt.innerHTML = '<div style="color: green; font-weight: bold; font-size: 1.25em">Q: Prompting... ' + transcript.substring(index) + '</div>';
                    ollamaResponse.innerText = 'A: ...';
                }

                if (e.results[0].isFinal && transcript && transcript.length > 0) {
                    let index = transcript.toLocaleLowerCase().indexOf(WAKE_WORD);
                    if (index < 0) {
                        //debugLog('WAKE WORD NOT DETECTED!');
                        return;
                    }
                    //debugLog('WAKE WORD DETECTED!');
                    const input = transcript.substring(index + WAKE_WORD.length);
                    if (input) {
                        debugLog(input);
                        ollamaPrompt.innerText = 'Q: ' + input;
                        ollamaResponse.innerText = 'A: ...';

                        // Define the request body
                        var requestBody = JSON.stringify({
                            "model": "llama2",
                            "messages": [{
                                "role": "user",
                                "content": input,
                            }]
                        });

                        // Send the request using Fetch API
                        fetch("http://localhost:11434/api/chat", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: requestBody
                        })
                            .then(async response => {
                                let text = await response.text();
                                //console.log("Text:", text);
                                // replace newlines with commas
                                text = text.split("\n").join(',');
                                if (text.endsWith(',')) {
                                    // remove trailing comma
                                    text = text.substring(0, text.length - 1);
                                }
                                // add brackets to make into array
                                text = '[' + text + ']';
                                document.getElementById("resultText").innerText = JSON.stringify(JSON.parse(text), null, 2);
                                return text;
                            })
                            .then(async text => {
                                const json = JSON.parse(text);
                                //console.log("JSON:", json);
                                // combine messages into one string
                                let content = '';
                                for (let i = 0; i < json.length; i++) {
                                    content += json[i]["message"]["content"];
                                }
                                if (!content) {
                                    ollamaResponse.innerText = 'A: nothing';
                                } else {
                                    ollamaResponse.innerText = 'A: ' + content;

                                    const speechSynthesis = window.speechSynthesis;
                                    if (speechSynthesis) {
                                        let words = content.split(' ');
                                        while (words.length > 0) {
                                            let sentence = [];
                                            for (let w = 0; w < 20; w++) {
                                                if (words.length == 0) {
                                                    break;
                                                }
                                                const word = words[0];
                                                sentence.push(word);
                                                //console.log('word', word);
                                                words.shift();
                                            }
                                            let output = sentence.join(' ');
                                            console.log('speak:', output);
                                            const utterance = new SpeechSynthesisUtterance();
                                            utterance.text = output;
                                            if (voicesDropdown.selectedIndex > 0) {
                                                const voice = speechSynthesisVoices[voicesDropdown.selectedIndex];
                                                utterance.lang = voice.lang;
                                                utterance.localService = voice.localService;
                                                utterance.name = voice.name;
                                                utterance.voiceURI = voice.voiceURI;
                                            } else {
                                                utterance.lang = 'en-US';
                                            }
                                            utterance.volume = 1;
                                            utterance.rate = 1;
                                            utterance.pitch = 1;

                                            speechSynthesis.speak(utterance);
                                            await sleep(4000);
                                        }
                                    }
                                }
                            })
                            .catch(error => {
                                console.error("Error:", error);
                                document.getElementById("result").innerHTML = "Error: " + error;
                            });
                    }
                }
            });

            recognition.addEventListener('end', recognition.start);

            if (recognition.start) {
                debugLog('SpeechRecognition has a start method');
                recognition.start();
                debugLog('SpeechRecognition: invoked start method');
            } else {
                showError('SpeechRecognition does not have a start method!');
            }
        }

        function setupSpeechSynthesis() {

            const speechSynthesis = window.speechSynthesis;
            if (!speechSynthesis) {
                showError('Speech Synthesis is not supported by your browser!');
                return;
            }

            if (speechSynthesis.getVoices) {
                setTimeout(function () {
                    speechSynthesisVoices = speechSynthesis.getVoices();
                    //console.log('speechSynthesisVoices', speechSynthesisVoices);

                    voicesDropdown.innerHTML = speechSynthesisVoices
                        .map(voice => `<option value="${voice.voiceURI}">${voice.name} (${voice.lang})</option>`)
                        .join('');

                    for (let i = 0; i < speechSynthesisVoices.length; i++) {
                        if (speechSynthesisVoices[i].lang === 'en-US') {
                            voicesDropdown.selectedIndex = i;
                            break;
                        }
                    }
                }, 100);
            }
        }

        function setup() {

            setupSpeechRecognition();

            setupSpeechSynthesis();

        }

        setup();
    </script>
</body>

</html>